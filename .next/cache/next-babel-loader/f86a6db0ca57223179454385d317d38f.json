{"ast":null,"code":"import pm from 'pm2';\nconst state = {\n  connected: false,\n  stable: true\n};\n\nconst connect = (noDaemon = false) => new Promise((resolve, reject) => pm.connect(noDaemon, err => err ? reject(err) : resolve()));\n\nconst disconnect = () => new Promise((resolve, reject) => pm.list(err => err ? reject(err) : resolve()));\n\nexport default (fn => {\n  return async (req, res) => {\n    try {\n      if (!state.stable) {\n        await disconnect();\n        state.connected = false;\n        state.stable = true;\n      }\n\n      if (!state.connected) {\n        await connect();\n        state.connected = true;\n        state.stable = true;\n      }\n    } catch (err) {\n      state.connected = false;\n      res.status(500).json({\n        message: `pm2: ${err}`\n      });\n      return;\n    }\n\n    await fn(req, res);\n  };\n});\nexport const getState = () => state;","map":null,"metadata":{},"sourceType":"module"}